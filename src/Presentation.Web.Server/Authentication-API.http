@client_id = test-client
@username = clever.dragon@example.com
@password = fantasy

###############################################################################################
## Authentication API Integration Tests                                                      ##
##                                                                                           ##
## This file exercises the authentication endpoints exposed by the Identity Provider feature ##
## https://github.com/BridgingIT-GmbH/bITdevKit/blob/main/docs/features-identityprovider.md  ##
## ----------------------------------------------------------------------------------------- ##
## Endpoints covered:                                                                        ##
##  GET    /api/_system/identity/connect/.well-known/openid-configuration (Discovery)        ##
##  POST   /api/_system/identity/connect/token            (Token endpoint - ROPC)            ##
##  GET    /api/_system/identity/connect/userinfo         (User info)                        ##
##  POST   /api/_system/identity/token                    (Refresh token)                    ##
##  GET    /api/_system/identity/authorize                (Authorization code flow)          ##
##                                                                                           ##
## Variables: (see http-client.env.json)                                                     ##
##  -client_id          The OAuth client identifier                                          ##
##  -username           Test user credentials                                                ##
##  -password           Test user credentials                                                ##
##  -access_token       Generated from sign_in request                                       ##
##  -refresh_token      Generated from sign_in request                                       ##
##                                                                                           ##
## ----------------------------------------------------------------------------------------- ##
## Use in Visual Studio: https://learn.microsoft.com/en-us/aspnet/core/test/http-files       ##
###############################################################################################

#############################################
### 1. Discovery Endpoint - OpenID Configuration
GET {{baseUrl}}/api/_system/identity/connect/.well-known/openid-configuration
Content-Type: application/json

#############################################
### 2. Resource Owner Password Flow
# @name login
POST {{baseUrl}}/api/_system/identity/connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password
&client_id={{client_id}}
&username={{username}}
&password={{password}}
&scope=openid profile email roles


#############################################
### 3. Get User Info using Access Token
GET {{baseUrl}}/api/_system/identity/connect/userinfo
Authorization: Bearer {{login.response.body.$.access_token}}
Content-Type: application/json

#############################################
### 4. Refresh Access Token
# @name refresh
POST {{baseUrl}}/api/_system/identity/connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token
&client_id={{client_id}}
&refresh_token={{login.response.body.$.refresh_token}}

#############################################
### 5. Authorization Code Flow
### 5.1 Get Authorization Code (Browser Required)
### Copy this URL to browser:
### https://localhost:5001/api/_system/identity/connect/authorize?response_type=code&client_id=blazor-wasm&scope=openid%20profile%20email%20roles&redirect_uri=https%3A%2F%2Flocalhost%3A5001%2Fauthentication%2Flogin-callback&state=random123
GET {{baseUrl}}/api/_system/identity/connect/authorize
    ?response_type=code
    &client_id={{client_id}}
    &scope=openid profile email roles
    &redirect_uri={{baseUrl}}/authenticatio/login-callback
    &state=random123

### 5.2 Exchange Code for Token
POST {{baseUrl}}/api/_system/identity/connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&client_id={{client_id}}
&code=[AUTH_CODE] # Copy from browser redirect URL (5.1 step)
&redirect_uri={{baseUrl}}